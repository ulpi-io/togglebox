name: Sync PHP SDKs

on:
  push:
    branches:
      - main

jobs:
  sync-php-sdks:
    name: Sync PHP SDKs to Split Repositories
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Debug - Check if PAT_TOKEN exists
        run: |
          if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
            echo "ERROR: PAT_TOKEN is empty or not set!"
            exit 1
          else
            echo "PAT_TOKEN is set (length: ${#PAT_TOKEN})"
          fi
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Split and push sdk-php
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Splitting packages/sdk-php..."
          git subtree split --prefix=packages/sdk-php -b sdk-php-split

          echo "Adding remote with token..."
          git remote add php-repo https://${{ secrets.PAT_TOKEN }}@github.com/ulpi-io/togglebox-php.git

          echo "Pushing to togglebox-php repository..."
          git push php-repo sdk-php-split:main --force

          git remote remove php-repo
          git branch -D sdk-php-split
          echo "✓ PHP SDK synced successfully"

      - name: Split and push sdk-laravel
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Splitting packages/sdk-laravel..."
          git subtree split --prefix=packages/sdk-laravel -b sdk-laravel-split

          echo "Adding remote with token..."
          git remote add laravel-repo https://${{ secrets.PAT_TOKEN }}@github.com/ulpi-io/togglebox-laravel.git

          echo "Pushing to togglebox-laravel repository..."
          git push laravel-repo sdk-laravel-split:main --force

          git remote remove laravel-repo
          git branch -D sdk-laravel-split
          echo "✓ Laravel SDK synced successfully"

      - name: Summary
        run: |
          echo "✓ Both PHP SDKs synced to split repositories"
          echo "- togglebox-php: https://github.com/ulpi-io/togglebox-php"
          echo "- togglebox-laravel: https://github.com/ulpi-io/togglebox-laravel"
