service: togglebox-config-service

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 30

  environment:
    NODE_ENV: production
    AWS_REGION_NAME: ${self:provider.region}
    DB_TYPE: dynamodb
    DYNAMODB_TABLE: ${self:custom.tablePrefix}
    LOG_LEVEL: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/log-level}
    LOG_PRETTY: 'false'
    CORS_ORIGIN: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/cors-origin}
    ENABLE_AUTHENTICATION: 'true'
    # Table names
    DYNAMODB_USERS_TABLE: ${self:custom.tableNames.users}
    DYNAMODB_API_KEYS_TABLE: ${self:custom.tableNames.apiKeys}
    DYNAMODB_PASSWORD_RESETS_TABLE: ${self:custom.tableNames.passwordResets}
    DYNAMODB_PLATFORMS_TABLE: ${self:custom.tableNames.platforms}
    DYNAMODB_ENVIRONMENTS_TABLE: ${self:custom.tableNames.environments}
    DYNAMODB_CONFIGS_TABLE: ${self:custom.tableNames.configs}
    DYNAMODB_REMOTE_CONFIGS_TABLE: ${self:custom.tableNames.remoteConfigs}
    DYNAMODB_FLAGS_TABLE: ${self:custom.tableNames.flags}
    DYNAMODB_EXPERIMENTS_TABLE: ${self:custom.tableNames.experiments}
    DYNAMODB_STATS_TABLE: ${self:custom.tableNames.stats}
    DYNAMODB_USAGE_TABLE: ${self:custom.tableNames.usage}
    # Cache configuration from SSM
    CACHE_ENABLED: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/cache/enabled}
    CACHE_PROVIDER: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/cache/provider}
    CLOUDFRONT_DISTRIBUTION_ID: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/cache/cloudfront-distribution-id~true}
    # Auth secrets from SSM Parameter Store
    JWT_SECRET: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/auth/jwt-secret}
    API_KEY_SECRET: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/auth/api-key-secret}

  iam:
    role:
      statements:
        # DynamoDB permissions for all tables
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            # Users table
            - !GetAtt UsersTable.Arn
            - !Sub "${UsersTable.Arn}/index/*"
            # API Keys table
            - !GetAtt ApiKeysTable.Arn
            - !Sub "${ApiKeysTable.Arn}/index/*"
            # Password Resets table
            - !GetAtt PasswordResetsTable.Arn
            - !Sub "${PasswordResetsTable.Arn}/index/*"
            # Platforms table
            - !GetAtt PlatformsTable.Arn
            - !Sub "${PlatformsTable.Arn}/index/*"
            # Environments table
            - !GetAtt EnvironmentsTable.Arn
            - !Sub "${EnvironmentsTable.Arn}/index/*"
            # Configs table
            - !GetAtt ConfigsTable.Arn
            - !Sub "${ConfigsTable.Arn}/index/*"
            # Remote Configs table
            - !GetAtt RemoteConfigsTable.Arn
            - !Sub "${RemoteConfigsTable.Arn}/index/*"
            # Flags table
            - !GetAtt FlagsTable.Arn
            - !Sub "${FlagsTable.Arn}/index/*"
            # Experiments table
            - !GetAtt ExperimentsTable.Arn
            - !Sub "${ExperimentsTable.Arn}/index/*"
            # Stats table
            - !GetAtt StatsTable.Arn
            - !Sub "${StatsTable.Arn}/index/*"
            # Usage table
            - !GetAtt UsageTable.Arn
            - !Sub "${UsageTable.Arn}/index/*"
        # CloudFront invalidation permissions
        - Effect: Allow
          Action:
            - cloudfront:CreateInvalidation
            - cloudfront:GetInvalidation
            - cloudfront:ListInvalidations
          Resource: "*"
        # SSM Parameter Store permissions
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/mumzworld-togglebox-api-${self:provider.stage}/*"

functions:
  # Public API - internet accessible (read-only endpoints)
  publicApi:
    handler: dist-bundle/lambda.lambdaHandler
    events:
      - http:
          path: /api/v1/platforms
          method: GET
          cors: true
      - http:
          path: /api/v1/platforms/{proxy+}
          method: GET
          cors: true
      - http:
          path: /health
          method: GET
          cors: false
      - http:
          path: /
          method: GET
          cors: false

  # Internal API - restricted to AWS account/VPC only (write operations)
  internalApi:
    handler: dist-bundle/lambda.lambdaHandler
    events:
      - http:
          path: /api/v1/internal/{proxy+}
          method: ANY
          cors: false

  # Auth API - public authentication endpoints
  authApi:
    handler: dist-bundle/lambda.lambdaHandler
    events:
      - http:
          path: /api/v1/auth/{proxy+}
          method: ANY
          cors: true
      - http:
          path: /api/v1/users/{proxy+}
          method: ANY
          cors: true
      - http:
          path: /api/v1/api-keys/{proxy+}
          method: ANY
          cors: true

custom:
  # Custom domain configuration from SSM
  customDomain:
    domainName: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/custom-domain/domain-name}
    certificateArn: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/custom-domain/certificate-arn}
    basePath: ''
    stage: ${self:provider.stage}
    createRoute53Record: true
    endpointType: 'regional'
    securityPolicy: tls_1_2
    apiType: rest

  # Table prefix from SSM
  tablePrefix: ${ssm:/mumzworld-togglebox-api-${self:provider.stage}/dynamodb/table-prefix}

  # Table names without stage suffix
  tableNames:
    users: ${self:custom.tablePrefix}-users
    apiKeys: ${self:custom.tablePrefix}-api-keys
    passwordResets: ${self:custom.tablePrefix}-password-resets
    platforms: ${self:custom.tablePrefix}-platforms
    environments: ${self:custom.tablePrefix}-environments
    configs: ${self:custom.tablePrefix}-configs
    remoteConfigs: ${self:custom.tablePrefix}-remote-configs
    flags: ${self:custom.tablePrefix}-flags
    experiments: ${self:custom.tablePrefix}-experiments
    stats: ${self:custom.tablePrefix}-stats
    usage: ${self:custom.tablePrefix}-usage

  serverless-offline:
    httpPort: 3000
    host: 0.0.0.0

package:
  individually: false
  patterns:
    - 'dist-bundle/**'
    - '!dist/**'
    - '!src/**'
    - '!node_modules/**'

resources:
  Resources:
    # =========================================================================
    # USERS TABLE
    # =========================================================================
    # Schema: PK = USER#{id}, GSI1PK = EMAIL#{email}
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.users}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # API KEYS TABLE
    # =========================================================================
    # Schema: PK = APIKEY#{id}, GSI1PK = USER#{userId}, GSI2PK = HASH#{keyHash}
    ApiKeysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.apiKeys}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # PASSWORD RESETS TABLE
    # =========================================================================
    # Schema: PK = RESET#{id}, GSI1PK = USER#{userId}, GSI2PK = HASH#{tokenHash}
    PasswordResetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.passwordResets}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # PLATFORMS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{name}, GSI1PK = PLATFORM, GSI1SK = PLATFORM#{name}
    PlatformsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.platforms}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # ENVIRONMENTS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{platform}, SK = ENV#{name}
    EnvironmentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.environments}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # CONFIGS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{p}#ENV#{e}, SK = VERSION#{timestamp}, GSI1PK = STABLE
    ConfigsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.configs}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # REMOTE CONFIGS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{p}#ENV#{e}, SK = CONFIG#{key}#V#{version}, GSI1PK = active lookup
    RemoteConfigsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.remoteConfigs}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # FLAGS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{p}#ENV#{e}, SK = FLAG#{key}#V#{version}, GSI1PK = active lookup
    FlagsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.flags}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # EXPERIMENTS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{p}#ENV#{e}, SK = EXP#{key}#V#{version}, GSI1PK = status lookup
    ExperimentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.experiments}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # STATS TABLE
    # =========================================================================
    # Schema: PK = PLATFORM#{p}#ENV#{e}, SK = STATS#{type}#{key}, GSI1 = time-based queries
    StatsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.stats}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

    # =========================================================================
    # USAGE TABLE
    # =========================================================================
    # Schema: PK = TENANT#{id}, SK = USAGE#apiRequests
    UsageTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.usage}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true

  Outputs:
    # Output table ARNs for reference
    UsersTableArn:
      Value: !GetAtt UsersTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-UsersTableArn
    ApiKeysTableArn:
      Value: !GetAtt ApiKeysTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-ApiKeysTableArn
    PlatformsTableArn:
      Value: !GetAtt PlatformsTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-PlatformsTableArn
    FlagsTableArn:
      Value: !GetAtt FlagsTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-FlagsTableArn
    ExperimentsTableArn:
      Value: !GetAtt ExperimentsTable.Arn
      Export:
        Name: ${self:service}-${self:provider.stage}-ExperimentsTableArn
    # API Gateway endpoints
    ApiGatewayRestApiId:
      Value: !Ref ApiGatewayRestApi
      Export:
        Name: ${self:service}-${self:provider.stage}-ApiGatewayRestApiId
    ServiceEndpoint:
      Value:
        Fn::Join:
          - ''
          - - 'https://'
            - Ref: ApiGatewayRestApi
            - '.execute-api.'
            - Ref: AWS::Region
            - '.amazonaws.com/dev'
      Export:
        Name: ${self:service}-${self:provider.stage}-ServiceEndpoint

plugins:
  - serverless-domain-manager
  - serverless-offline
